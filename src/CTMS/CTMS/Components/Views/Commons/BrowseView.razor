@using Syncfusion.Blazor
@using Syncfusion.Blazor.Data
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Calendars

@inject NavigationManager NavigationManager
@inject CurrentUserService CurrentUserService
@inject AuthenticationStateHelper AuthenticationStateHelper
@inject AuthenticationStateProvider authStateProvider
@inject PatientService PatientService
@inject BrowsePatientService BrowsePatientService
@inject NavigationManager NavigationManager
@inject DropDownListDataService DropDownListDataService
@inject AutoMapper.IMapper Mapper
@inject BrowseSearchingService BrowseSearchingService
@inject RandomListService RandomListService

<div class="browse-container">
    <!-- 功能按鈕區域 -->
    <div class="function-buttons">
        <button class="btn btn-add" @onclick="@(async () => await OnAddAsync())">
            <span class="icon-plus">+</span> 新增病患資料
        </button>
        <button class="btn btn-refresh" @onclick="@(async () => await OnRefreshAsync())">
            <span class="icon-refresh">↻</span> 重新整理
        </button>
    </div>

    <!-- 篩選條件區域 -->
    <div class="filter-section">
        <div class="filter-header">
            <h2>篩選條件</h2>
            <a class="clear-filter"
               @onclick="@(async () => await RemovellFilterAsync())">清除所有篩選條件</a>
        </div>

        <div class="filter-items">
            <div class="filter-group">
                <label>醫院名稱</label>
                <div class="select-container">
                    <SfDropDownList TValue="DropDownListDataModel" TItem="DropDownListDataModel"
                                    Placeholder="請選擇醫院名稱" DataSource="@List院別"
                                    @bind-Value="@Select院別" class="flex-grow-1">
                        <DropDownListFieldSettings Value="Key" Text="Name"></DropDownListFieldSettings>
                        <DropDownListEvents TItem="DropDownListDataModel" TValue="DropDownListDataModel"
                                            ValueChange="@On院別Changed"></DropDownListEvents>
                    </SfDropDownList>
                </div>
            </div>
            <div class="filter-group">
                <label>癌症類型</label>
                <div class="select-container">
                    <SfDropDownList TValue="DropDownListDataModel" TItem="DropDownListDataModel"
                                    Placeholder="請選擇癌症類型" DataSource="@List癌別"
                                    @bind-Value="@Select癌別" class="flex-grow-1">
                        <DropDownListFieldSettings Value="Key" Text="Name"></DropDownListFieldSettings>
                        <DropDownListEvents TItem="DropDownListDataModel" TValue="DropDownListDataModel"
                                            ValueChange="@On癌別Changed"></DropDownListEvents>
                    </SfDropDownList>
                </div>
            </div>
            <div class="search-container">
                <label></label>
                <div class="search-box">
                    <span class="search-icon" @onclick=OnSetKeyword>🔍</span>
                    <input type="text" placeholder="搜尋病患編號" @bind="Keyword" />
                </div>
            </div>
        </div>

        <div class="filter-items">
            <div class="filter-tags">
                @foreach (var item in browseFilterCondition.Items)
                {
                    <div class="filter-tag">
                        @item.Name
                        <span class="tag-remove" @onclick="@(async () => await RemoveFilterAsync(item))">×</span>
                    </div>
                }
            </div>
            <div class="filter-result">
                <span class="result-icon">✓</span> 共找到 @FoundCount 位符合條件的病患
            </div>
        </div>

    </div>

    <!-- 結果表格區域 -->
    <div>
        <Table @ref="table" Style="font-size:30px;"
               TItem="PatientAdapterModel"
               DataSource="@patientsAdapterModel"
               Total="_total"
               @bind-PageIndex="_pageIndex"
               @bind-PageSize="_pageSize">
            <Column TData="string" DataIndex="@nameof(PatientAdapterModel.SubjectNo)" Title="病人編號" />
            <Column TData="string" DataIndex="@nameof(PatientAdapterModel.醫院)" Title="醫院名稱" />
            <Column TData="string" DataIndex="@nameof(PatientAdapterModel.組別中文)" Title="癌症類型" />
            <Column TData="string" DataIndex="@nameof(PatientAdapterModel.AI處理)" Title="組別" />
            <Column TData="string" DataIndex="@nameof(PatientAdapterModel.AI評估)" Title="AI處理" />
            <ActionColumn Fixed="ColumnFixPlacement.Right" Title="操作">
                <Space>
                    <SpaceItem>
                        <button class="btn-edit" title="修改"
                                @onclick="@(async () => await OnEditAsync(@context))">
                            <span class="icon-edit">✏️</span> 修改
                        </button>
                    </SpaceItem>
                    <SpaceItem>
                        <button class="btn-delete" title="刪除"
                                @onclick="@(async () => await OnDeleteAsync(@context))">
                            <span class="icon-delete">🗑️</span> 刪除
                        </button>
                    </SpaceItem>

                </Space>
            </ActionColumn>
        </Table>
    </div>

</div>

<AddPatientDialog OpenPicker=@ShowAddPatientDialog OnConfirmCallback=OnAddPatientAsync />

<MessageBox Height="@MessageBox.Height" Width="@MessageBox.Width"
            IsVisible="@MessageBox.IsVisible"
            Title="@MessageBox.Title" Message="@MessageBox.Body"
            Callback="MessageBox.MessageDelegate" />

<ConfirmBox Height="@ConfirmMessageBox.Height" Width="@ConfirmMessageBox.Width"
            IsVisible="@ConfirmMessageBox.IsVisible"
            Title="@ConfirmMessageBox.Title" Message="@ConfirmMessageBox.Body"
            Callback="ConfirmMessageBox.ConfirmDelegate" />

<DialogBackground />


@code {
    HomePageModel HomePageModel = new();
    string imagefile = "";

    ConfirmBoxModel ConfirmMessageBox { get; set; } = new ConfirmBoxModel();
    MessageBoxModel MessageBox { get; set; } = new MessageBoxModel();
    string RoleMessage = string.Empty;

    bool ShowAddPatientDialog = false;

    List<Patient> patients = new();
    List<PatientAdapterModel> patientsAdapterModel = new();
    PatientData patientData = new();

    BrowseFilterCondition browseFilterCondition = new();
    string Keyword = string.Empty;
    int FoundCount = 0;

    #region 拉霸選單物件宣告
    List<DropDownListDataModel> List癌別 = new List<DropDownListDataModel>();
    DropDownListDataModel Select癌別 = new DropDownListDataModel();
    List<DropDownListDataModel> List院別 = new List<DropDownListDataModel>();
    DropDownListDataModel Select院別 = new DropDownListDataModel();
    #endregion

    ITable table;
    int _pageIndex = 1;
    int _pageSize = 5;
    int _total = 0;


    private async Task PageIndexChanged(PaginationEventArgs args)
    {
        _pageIndex = args.Page;
        await ReloadAsync();
    }

    private async Task PageSizeChange(PaginationEventArgs args)
    {
        _pageSize = args.PageSize;
        await ReloadAsync();
    }

    protected override async Task OnInitializedAsync()
    {
        Keyword = BrowseSearchingService.BrowseSearchingModel.SearchKeyword;
        foreach (var item in BrowseSearchingService.BrowseSearchingModel.院別)
        {
            browseFilterCondition.Items.Add(new BrowseFilterConditionNode()
            {
                Category = MagicObjectHelper.院別,
                Name = item,
            });
        }
        foreach (var item in BrowseSearchingService.BrowseSearchingModel.癌別)
        {
            browseFilterCondition.Items.Add(new BrowseFilterConditionNode()
            {
                Category = MagicObjectHelper.癌別,
                Name = item,
            });
        }
        DropDownListDataInit();
        await ReloadAsync();
    }

    async Task OnSetKeyword()
    {
        BrowseSearchingService.SetSearchKeyword(Keyword);
        await ReloadAsync();
    }

    async Task ReloadAsync()
    {
        patientsAdapterModel = await PatientService.GetAsync(BrowseSearchingService.BrowseSearchingModel);
        foreach (var item in patientsAdapterModel)
        {
            patientData.FromJson(item.JsonData);
            item.SubjectNo = patientData.臨床資訊.SubjectNo; // Accessing PatientId property
            item.Get組別DisplayName();
        }
        FoundCount = patientsAdapterModel.Count;
        StateHasChanged(); // 更新 UI
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
        }
    }

    async Task OnEditAsync(PatientAdapterModel patientAdapterModel)
    {
        patientData.FromJson(patientAdapterModel.JsonData);
        var url = $"/BasicClinical/{patientAdapterModel.Code}";
        NavigationManager.NavigateTo(url);

    }

    async Task OnDeleteAsync(PatientAdapterModel patientAdapterModel)
    {

        patientData.FromJson(patientAdapterModel.JsonData);
        string subjectNo = patientData.臨床資訊.SubjectNo;
        string FIGO = patientData.臨床資訊.FIGOStaging;
        // 使用 ConfirmMessageBox 來確認刪除操作
        var confirmDelete = await ConfirmMessageBox.ShowAsync("400px", "200px",
        "刪除病患資料", $"確定要刪除病患 {patientData.臨床資訊.SubjectNo} 的資料嗎？",
        ConfirmMessageBox.HiddenAsync);

        if (confirmDelete == true)
        {
            // 刪除病患資料的邏輯
            var deleteResult = await PatientService.DeleteAsync(patientAdapterModel.Id);
            if (deleteResult.Success)
            {

                RandomParameterMode randomParameterModeAfter = new RandomParameterMode()
                {
                    SubjectNo = subjectNo,
                    FIGO = FIGO,
                };
                randomParameterModeAfter.Parse();
                await RandomListService.RemoveAsync(randomParameterModeAfter);


                // 刪除成功，顯示提示訊息
                // await MessageBox.ShowAsync("400px", "200px", "成功", "病患資料已成功刪除。", MessageBox.HiddenAsync);
                await ReloadAsync();
            }
            else
            {
                // 刪除失敗，顯示錯誤訊息
                await MessageBox.ShowAsync("400px", "200px", "錯誤", deleteResult.Message, MessageBox.HiddenAsync);
            }
            StateHasChanged(); // 更新 UI
        }
        else
        {
            // 使用者取消刪除操作
        }
    }

    async Task OnAddAsync()
    {
        if (AuthenticationStateHelper.CheckShowPage(MagicObjectHelper.ROLE新增病患, ConfirmMessageBox) == false)
            return;

        ShowAddPatientDialog = true;
    }

    async Task OnAddPatientAsync(string Hospital)
    {
        if (Hospital != null)
        {
            await AddNewPatientAsync(Hospital);
        }
        else
        {
            ShowAddPatientDialog = false;
            StateHasChanged(); // 更新 UI
            await Task.Delay(100); // 等待對話框關閉動畫完成
                                   // 使用者取消新增操作
        }
    }

    async Task AddNewPatientAsync(string Hospital)
    {
        // 呼叫新增病患的服務方法
        var result = await PatientService.AddEmptyAsync(Hospital);
        if (result.Success)
        {
            ShowAddPatientDialog = false;
            StateHasChanged(); // 更新 UI
            await Task.Delay(100); // 等待對話框關閉動畫完成
                                   // 新增成功，顯示提示訊息
            MessageBox.Show("400px", "200px", "成功", "病患資料已成功新增。", MessageBox.HiddenAsync);
            await ReloadAsync();
        }
        else
        {
            // 新增失敗，顯示錯誤訊息
            await MessageBox.ShowAsync("400px", "200px", "錯誤", result.Message, MessageBox.HiddenAsync);
        }
    }


    async Task OnRefreshAsync()
    {
        await ReloadAsync();
    }

    void DropDownListDataInit()
    {
        #region 癌別
        {
            List癌別 = DropDownListDataService.Get癌別();
        }
        #endregion

        #region 院別
        {
            List院別 = DropDownListDataService.Get院別();
        }
        #endregion

    }

    async Task RemoveFilterAsync(BrowseFilterConditionNode item)
    {
        if (item == null) return;
        browseFilterCondition.Items.Remove(item);
        if (item.Category == MagicObjectHelper.院別)
            BrowseSearchingService.RemoveHospital(item.Name);
        else if (item.Category == MagicObjectHelper.癌別)
            BrowseSearchingService.RemoveCancerType(item.Name);
        await ReloadAsync();
    }

    async Task RemovellFilterAsync()
    {
        BrowseSearchingService.Reset();
        browseFilterCondition.Items.Clear();
        BrowseSearchingService.Reset();
        await ReloadAsync();
    }

    async Task On院別Changed(ChangeEventArgs<DropDownListDataModel, DropDownListDataModel> args)
    {
        if (args.Value == null) return;
        // patientData.臨床資訊.ECorOC = args.Value.Key;

        var item = browseFilterCondition.Items.FirstOrDefault(i => i.Name == args.Value.Name);
        if (item == null)
        {
            browseFilterCondition.Items.Add(new BrowseFilterConditionNode
            {
                Category = MagicObjectHelper.院別,
                Name = args.Value.Name
            });
            BrowseSearchingService.AddHospital(args.Value.Name);
        }

        await ReloadAsync();
    }

    async Task On癌別Changed(ChangeEventArgs<DropDownListDataModel, DropDownListDataModel> args)
    {
        if (args.Value == null) return;

        var item = browseFilterCondition.Items.FirstOrDefault(i => i.Name == args.Value.Name);
        if (item == null)
        {
            browseFilterCondition.Items.Add(new BrowseFilterConditionNode
            {
                Category = MagicObjectHelper.癌別,
                Name = args.Value.Name
            });
            BrowseSearchingService.AddCancerType(args.Value.Name);
        }

        await ReloadAsync();
    }
}