@using Syncfusion.Blazor
@using Syncfusion.Blazor.Data
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.Buttons

@inject OperationHistoryTraceViewModel ViewModel
@implements IRazorPage
@implements IDataGrid

<style>
    .multiline3-textbox textarea {
        min-height: 120px !important;
        height: 80px !important;
        font-size: 24px !important; /* 新增字體大小 */
        line-height: 1.4;
    }

    .multiline-textbox textarea {
        min-height: 120px !important;
        height: 350px !important;
        font-size: 24px !important; /* 新增字體大小 */
        line-height: 1.4;
    }

    /* 包一層外框，針對該 Grid 內所有文字放大為 20px */
    .operation-history-grid .e-grid,
    .operation-history-grid .e-grid .e-headercell,
    .operation-history-grid .e-grid .e-rowcell,
    .operation-history-grid .e-grid .e-toolbar-item,
    .operation-history-grid .e-grid .e-pager,
    .operation-history-grid .e-grid .e-pager .e-numericitem,
    .operation-history-grid .e-grid .e-command-column .e-btn,
    .operation-history-grid .e-grid .e-icons {
        font-size: 20px !important;
        line-height: 1.35;
    }


    /* Dialog 內表單文字 20px */
    .operation-history-edit-dialog,
    .operation-history-edit-dialog label,
    .operation-history-edit-dialog .e-input,
    .operation-history-edit-dialog .e-input-group,
    .operation-history-edit-dialog .e-control,
    .operation-history-edit-dialog .e-btn,
    .operation-history-edit-dialog .validation-message {
        font-size: 20px !important;
        line-height: 1.2;
    }

        /* Dialog 內表單文字 20px */
        .operation-history-edit-dialog .multiline-textbox textarea,
        .operation-history-edit-dialog .multiline3-textbox textarea {
            font-size: 28px !important;
            line-height: 1.4;
        }

</style>

<div class="operation-history-grid">
    <SfGrid @ref="Grid" TValue="OperationHistoryTraceAdapterModel"
            AllowPaging="true"
            Toolbar="ViewModel.Toolbaritems">
        <SfDataManager Adaptor="Adaptors.CustomAdaptor">
            <OperationHistoryTraceAdapter></OperationHistoryTraceAdapter>
        </SfDataManager>
        <SfToolbar>
        </SfToolbar>
        <GridEvents CommandClicked="ViewModel.OnCommandClicked" TValue="OperationHistoryTraceAdapterModel"
                    OnToolbarClick="ViewModel.ToolbarClickHandler" />
        <GridPageSettings PageSize="@PageSize" />
        <GridColumns>
            <GridColumn Field=@nameof(OperationHistoryTraceAdapterModel.User)
                        HeaderText="使用者" />
            <GridColumn Field=@nameof(OperationHistoryTraceAdapterModel.Category)
                        HeaderText="類型" />
            <GridColumn Field=@nameof(OperationHistoryTraceAdapterModel.SubjectCode)
                        HeaderText="Subject No" />
            <GridColumn Field=@nameof(OperationHistoryTraceAdapterModel.Name)
                        HeaderText="主題" />
            <GridColumn Field=@nameof(OperationHistoryTraceAdapterModel.Description)
                        HeaderText="主題"
                        HideAtMedia="(min-width: 640px)" />
            <GridColumn Field=@nameof(OperationHistoryTraceAdapterModel.CreateAt)
                        HeaderText="發生時間"
                        HideAtMedia="(min-width: 640px)" />
            <GridColumn HeaderText="命令" Width="@MagicObjectHelper.DataGrid3個命令寬度" TextAlign="@TextAlign.Center"
                        CustomAttributes="@(new Dictionary<string, object>(){ { "class", "p-0 m-0" }})">
                <GridCommandColumns>
                    <GridCommandColumn Title="@ButtonIdHelper.ButtonNameEdit"
                                       ButtonOption="@(new CommandButtonOptions()
                                       { Content = "", IconCss = @ButtonIdHelper.ButtonIdEdit })" />
                    <GridCommandColumn Title="@ButtonIdHelper.ButtonNameRetry"
                                       ButtonOption="@(new CommandButtonOptions()
                                       { Content = "", IconCss = @ButtonIdHelper.ButtonIdRetry })" />
                    <GridCommandColumn Title="@ButtonIdHelper.ButtonNameDelete"
                                       ButtonOption="@(new CommandButtonOptions()
                                       { Content = "", IconCss = ButtonIdHelper.ButtonIdDelete })" />
                </GridCommandColumns>
            </GridColumn>
        </GridColumns>
    </SfGrid>
</div>

<SfDialog @bind-Visible="@ViewModel.IsShowEditRecord" IsModal="true"
          Width="95%" Height="100%" CssClass="dialogSize operation-history-edit-dialog">
    <DialogTemplates>
        <Header>@ViewModel.EditRecordDialogTitle</Header>
        <Content>
            <EditForm Model="@ViewModel.CurrentRecord">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <InputWatcher EditContextActionChanged="@ViewModel.OnEditContestChanged" />

                <div>
                    <div class="form-row">
                        <div class="form-group col">
                            <label class="control-label">使用者</label>
                            <SfTextBox @bind-Value="ViewModel.CurrentRecord.User"
                                       Placeholder="請輸入使用者" />
                            <ValidationMessage For="@(() => ViewModel.CurrentRecord.User)" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col">
                            <label class="control-label">分類</label>
                            <SfTextBox @bind-Value="ViewModel.CurrentRecord.Category"
                                       Placeholder="請輸入分類" />
                            <ValidationMessage For="@(() => ViewModel.CurrentRecord.Category)" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col">
                            <label class="control-label">主題</label>
                            <SfTextBox @bind-Value="ViewModel.CurrentRecord.Name"
                                       Placeholder="請輸入主題"
                                       Multiline="true"
                                       RowCount="3"
                                       CssClass="multiline3-textbox" />
                            <ValidationMessage For="@(() => ViewModel.CurrentRecord.Name)" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col">
                            <label class="control-label">詳細說明</label>
                            <SfTextBox @bind-Value="ViewModel.CurrentRecord.Description"
                                       Placeholder="請輸入詳細說明"
                                       Multiline="true"
                                       RowCount="10"
                                       CssClass="multiline-textbox" />
                            <ValidationMessage For="@(() => ViewModel.CurrentRecord.Description)" />
                        </div>
                    </div>
                </div>
            </EditForm>
        </Content>
        <FooterTemplate>
            <div>
                <SfButton type="submit" CssClass="e-primary" @onclick="ViewModel.OnRecordEditConfirm">儲存</SfButton>
                <SfButton CssClass="e-secondary" @onclick="ViewModel.OnRecordEditCancel">取消</SfButton>
            </div>
        </FooterTemplate>
    </DialogTemplates>
    <DialogPositionData X="center" Y="center"></DialogPositionData>
</SfDialog>

<MessageBox Height="@ViewModel.MessageBox.Height" Width="@ViewModel.MessageBox.Width"
            IsVisible="@ViewModel.MessageBox.IsVisible"
            Title="@ViewModel.MessageBox.Title" Message="@ViewModel.MessageBox.Body"
            Callback="ViewModel.MessageBox.MessageDelegate" />

<ConfirmBox Height="@ViewModel.ConfirmMessageBox.Height" Width="@ViewModel.ConfirmMessageBox.Width"
            IsVisible="@ViewModel.ConfirmMessageBox.IsVisible"
            Title="@ViewModel.ConfirmMessageBox.Title" Message="@ViewModel.ConfirmMessageBox.Body"
            Callback="ViewModel.ConfirmMessageBox.ConfirmDelegate" />

<DialogBackground />
<DataGridCss />

@code {
    SfGrid<OperationHistoryTraceAdapterModel> Grid;
    [Parameter]
    public int PageSize { get; set; } = 15;
    [Parameter]
    public EventCallback<MasterRecord> OnRecordChanged { get; set; }
    [Parameter]
    public EventCallback<object> OnViewRender { get; set; }

    #region 生命週期事件
    protected override void OnInitialized()
    {
        ViewModel.Setup(this, this);
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender == true)
        {
            ViewModel.Setup(this, this);
        }
        if (OnViewRender.HasDelegate)
        {
            await OnViewRender.InvokeAsync(null);
        }
    }
    #endregion

    #region 頁面需要介面實作
    public async Task NeedRefreshAsync()
    {
        await InvokeAsync(async () =>
        {
            await RenderDelayHelper.Delay();
            StateHasChanged();
        });
    }

    public async Task NeedInvokeAsync(System.Action action)
    {
        await InvokeAsync(action);
    }
    public void RefreshGrid()
    {
        Grid?.Refresh();
    }
    public bool GridIsExist()
    {
        return Grid == null ? false : true;
    }
    public Task InvokeGridAsync(string actionName)
    {
        return Task.CompletedTask;
    }
    #endregion

}
