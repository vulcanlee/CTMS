@using CTMS.DataModel.Models.AIAgent
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Data
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Calendars
@using System.Threading.Tasks
@inject NavigationManager NavigationManager
@inject PatientService PatientService
@inject DropDownListDataService DropDownListDataService
@inject BloodExameService BloodExameService
@inject RandomListService RandomListService
@inject ZipToolService ZipToolService
@inject IJSRuntime JS

<div>
    @{
        var index = 0;
        string rowClass = string.Empty;
    }

    <div class="sample-table-container">
        @if (KeyNameList != null && KeyNameList.Count > 0)
        {
            <div class="mb-3">
                <button class="btn btn-primary" @onclick=OnDeleteKeyNameDirectory>
                    <i class="fa fa-arrow-left"></i> 刪除
                </button>
            </div>

            <table class="sample-table">
                <thead>
                    <tr>
                        <th class="">Key Name 目錄</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        index = 0;
                        rowClass = string.Empty;
                    }
                    @foreach (var item in KeyNameList)
                    {
                        if (index++ % 2 == 0)
                        {
                            rowClass = "row-normal";
                        }
                        else
                        {
                            rowClass = "row-highlighted";
                        }
                        <tr class="@rowClass">
                            <td class="item-cell ">@item</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        @if (Items != null && Items.Count > 0)
        {
            <table class="sample-table mt-4">
                <thead>
                    <tr>
                        <th class="">Subject Code</th>
                        <th class="">Key Name</th>
                        <th class="">動作</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        index = 0;
                        rowClass = string.Empty;
                    }
                    @foreach (var item in Items)
                    {
                        if (index++ % 2 == 0)
                        {
                            rowClass = "row-normal";
                        }
                        else
                        {
                            rowClass = "row-highlighted";
                        }
                        <tr class="@rowClass">
                            <td class="item-cell ">@item.SubjectNo</td>
                            <td class="item-cell cursor-pointer"
                                @onclick="@(async () => OnKeyNameClick(item))">
                                @item.KeyName
                            </td>
                            <td class="item-cell ">
                                <Button Type="AntDesign.ButtonType.Primary"
                                        OnClick="()=>OnShowPicker(item)">
                                    變更病歷號
                                </Button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<MessageBox Height="@MessageBox.Height" Width="@MessageBox.Width"
            IsVisible="@MessageBox.IsVisible"
            Title="@MessageBox.Title" Message="@MessageBox.Body"
            Callback="MessageBox.MessageDelegate" />

<ConfirmBox Height="@ConfirmMessageBox.Height" Width="@ConfirmMessageBox.Width"
            IsVisible="@ConfirmMessageBox.IsVisible"
            Title="@ConfirmMessageBox.Title" Message="@ConfirmMessageBox.Body"
            Callback="ConfirmMessageBox.ConfirmDelegate" />

<NewSubjectNoDialog OpenPicker="OpenChangeSubjectNoPicker" OnConfirmCallback="OnChangeSubjectNo" newSubjectNo=@sourceSubjectNo />

<DialogBackground />

@code {
    public class PatientAIKeyNameViewModel
    {
        public string SubjectNo { get; set; } = string.Empty;
        public string KeyName { get; set; } = string.Empty;
    }

    ConfirmBoxModel ConfirmMessageBox { get; set; } = new ConfirmBoxModel();
    MessageBoxModel MessageBox { get; set; } = new MessageBoxModel();
    List<PatientAIKeyNameViewModel> Items = new();
    PatientData patientData = new();
    List<string> KeyNameList = new();

    public bool OpenChangeSubjectNoPicker { get; set; } = false;
    public string sourceSubjectNo { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await GetDataAsync(firstRender);
            await GetKeyNameDirectory(firstRender);
        }
    }
    async Task OnDeleteKeyNameDirectory()
    {
        foreach (var keyName in KeyNameList)
        {
            var uploadFilesPath = MagicObjectHelper.UploadFinalPath;
            var dirPath = Path.Combine(uploadFilesPath, keyName);
            if (Directory.Exists(dirPath))
            {
                Directory.Delete(dirPath, true);
            }
        }
        MessageBox.Show("400px", "200px", "資訊", "已成功刪除所有沒有用到的目錄。", MessageBox.HiddenAsync);
        await GetKeyNameDirectory(false);
    }

    async Task GetKeyNameDirectory(bool firstRender)
    {
        KeyNameList.Clear();
        var uploadFilesPath = MagicObjectHelper.UploadFinalPath;
        // get all directory
        var directories = Directory.GetDirectories(uploadFilesPath);
        foreach (var dir in directories)
        {
            var dirInfo = new DirectoryInfo(dir);
            var dirName = dirInfo.Name;
            var existingItem = Items.FirstOrDefault(x => x.KeyName == dirName);
            if (existingItem == null)
            {
                KeyNameList.Add(dirName);
            }
        }

        if (firstRender)
        {
            StateHasChanged();
        }
    }

    async Task GetDataAsync(bool firstRender = false)
    {
        Items.Clear();
        var patientItems = await PatientService.GetAsync();
        foreach (var patient in patientItems)
        {
            patientData.FromJson(patient.JsonData);
            var model = new PatientAIKeyNameViewModel()
            {
                SubjectNo = patientData.臨床資訊.SubjectNo,
                KeyName = patientData.臨床資訊.KeyName
            };
            Items.Add(model);
        }

        if (firstRender)
        {
            StateHasChanged();
        }
    }

    async Task OnKeyNameClick(PatientAIKeyNameViewModel patientAIKeyNameViewModel)
    {
        string keyName = patientAIKeyNameViewModel.KeyName;
        string subjectNo = patientAIKeyNameViewModel.SubjectNo;
        if (string.IsNullOrEmpty(keyName))
        {
            return;
        }
        var uploadFilesPath = MagicObjectHelper.UploadFinalPath;
        var sourceDirectoryPath = Path.Combine(uploadFilesPath, keyName);
        var zipFileName = await ZipToolService.CompressDirectoryToZipAsync(sourceDirectoryPath, MagicObjectHelper.DownloadPath, subjectNo);

        MemoryStream fileStream = new MemoryStream(File.ReadAllBytes(zipFileName));
        using var streamRef = new DotNetStreamReference(stream: fileStream);

        await JS.InvokeVoidAsync("downloadFileFromStream", Path.GetFileName(zipFileName), streamRef);
    }

    async Task OnShowPicker(PatientAIKeyNameViewModel patientAIKeyNameViewModel)
    {
        string keyName = patientAIKeyNameViewModel.KeyName;
        string subjectNo = patientAIKeyNameViewModel.SubjectNo;
        sourceSubjectNo = subjectNo;
        OpenChangeSubjectNoPicker = true;
    }

    // Stream GetFileStream()
    // {
    //     MemoryStream memoryStream = new MemoryStream(File.ReadAllBytes(fileNamePdf));
    //     return memoryStream;
    // }
    private async Task OnChangeSubjectNo(string args)
    {
        string willReplaceSubjectNo = args;
        OpenChangeSubjectNoPicker = false;
        StateHasChanged();
        var patientItems = await PatientService.GetAsync();

        var found = Items.FirstOrDefault(x => x.SubjectNo == willReplaceSubjectNo);
        if (found != null)
        {
            MessageBox.Show("400px", "200px", "錯誤", "此 Subject Code 已存在，請重新輸入。", MessageBox.HiddenAsync);
            return;
        }

        bool isFound = false;
        PatientAdapterModel patient = new PatientAdapterModel();
        foreach (var item in patientItems)
        {
            patientData.FromJson(item.JsonData);
            if (patientData.臨床資訊.SubjectNo == sourceSubjectNo)
            {
                patient = item;
                isFound = true;
                break;
            }
        }

        #region 更新隨機碼
        await RandomListService.InitialAsync();
        var RandomListItems = RandomListService.RandomList.Items.ToList();
        var randomListItem = RandomListItems.FirstOrDefault(x => x.SubjectNo == sourceSubjectNo);
        if (randomListItem != null)
        {
            randomListItem.SubjectNo = willReplaceSubjectNo;
        }
        await RandomListService.SaveAsync(RandomListItems);

        #endregion

        #region 更新 DICOM 檔案內的 Subject Code
        string sourceImagePngFilename = Path.Combine(MagicObjectHelper.UploadFinalPath, patientData.臨床資訊.ImagePng);
        string sourceDicomPngFilename = Path.Combine(MagicObjectHelper.UploadFinalPath, patientData.臨床資訊.ImageDicom);

        patientData.臨床資訊.Image = patientData.臨床資訊.Image.Replace(sourceSubjectNo, willReplaceSubjectNo);

        string targetImagePngFilename = Path.Combine(MagicObjectHelper.UploadFinalPath, patientData.臨床資訊.ImagePng);
        string targetDicomPngFilename = Path.Combine(MagicObjectHelper.UploadFinalPath, patientData.臨床資訊.ImageDicom);

        // rename image png file
        if (File.Exists(sourceImagePngFilename))
        {
            File.Move(sourceImagePngFilename, targetImagePngFilename, overwrite: true);
        }
        // rename dicom png file
        if (File.Exists(sourceDicomPngFilename))
        {
            File.Move(sourceDicomPngFilename, targetDicomPngFilename, overwrite: true);
        }
        #endregion

        #region 更新 KeyName 的 PatientData.json 內的 Subject Code
        if (string.IsNullOrEmpty(patientData.臨床資訊.KeyName) == false)
        {
            var uploadFilesPath = MagicObjectHelper.UploadFinalPath;
            var destinationKeyNamePath = Path.Combine(uploadFilesPath, patientData.臨床資訊.KeyName);
            string PatientDataFilename = "";
            string Content = "";
            PatientAIInfo patientAIInfo = new PatientAIInfo();
            PatientDataFilename = Path.Combine(destinationKeyNamePath, $"PatientData.json");
            if (File.Exists(PatientDataFilename))
            {
                Content = await File.ReadAllTextAsync(PatientDataFilename);
                patientAIInfo = patientAIInfo.FromJson(Content);
                patientAIInfo.SubjectCode = willReplaceSubjectNo;
                Content = patientAIInfo.ToJson();
                await File.WriteAllTextAsync(PatientDataFilename, Content);
            }
        }
        #endregion

        #region 更新 臨床資訊
        patientData.臨床資訊.SubjectNo = willReplaceSubjectNo;
        #endregion

        #region 更新 臨床資料
        #region 臨床資料手術
        foreach (var item in patientData.臨床資料.臨床資料手術.Items)
        {
            item.SubjectNo = willReplaceSubjectNo;
        }
        #endregion

        #region 臨床資料病理報告
        foreach (var item in patientData.臨床資料.臨床資料病理報告.Items)
        {
            item.SubjectNo = willReplaceSubjectNo;
        }
        #endregion

        #region 臨床資料化學治療
        foreach (var item in patientData.臨床資料.臨床資料化學治療.Items)
        {
            item.SubjectNo = willReplaceSubjectNo;
        }
        #endregion

        #region 臨床資料合併用藥
        foreach (var item in patientData.臨床資料.臨床資料合併用藥.Items)
        {
            item.SubjectNo = willReplaceSubjectNo;
        }
        #endregion

        #region BaselineMedicalHistoryForm
        foreach (var item in patientData.臨床資料.BaselineMedicalHistoryForm.Items)
        {
            item.SubjectNo = willReplaceSubjectNo;
        }
        #endregion

        #region 其他治療
        foreach (var item in patientData.臨床資料.其他治療.Items)
        {
            item.SubjectNo = willReplaceSubjectNo;
        }
        #endregion

        #region 其他治療藥物
        foreach (var item in patientData.臨床資料.其他治療藥物.Items)
        {
            item.SubjectNo = willReplaceSubjectNo;
        }
        #endregion

        #region 其他治療影像
        foreach (var item in patientData.臨床資料.其他治療影像.Items)
        {
            item.SubjectNo = willReplaceSubjectNo;
        }
        #endregion



        #endregion

        patient.JsonData = patientData.ToJson();
        patient.SubjectNo = willReplaceSubjectNo;
        await PatientService.UpdateAsync(patient);

    }
}
